#!/bin/bash

dbc_dir=`pwd`
server=frs.sourceforge.net:uploads

# SVN Commit #

echo -en "Did you commit to SVN? (Y/n) "; read ci
if [ "$ci" != "Y" ]; then
    echo -en "ERROR: You must commit before releasing\n"
    exit 1;
fi

# Release Numbers #

old_major=`cat $dbc_dir/bin/release.dat | egrep "^Major: .*$" | sed 's/^Major: //'`
old_minor=`cat $dbc_dir/bin/release.dat | egrep "^Minor: .*$" | sed 's/^Minor: //'`
old_rev=`cat $dbc_dir/bin/release.dat | egrep "^Revision: .*$" | sed 's/^Revision: //'`

new_rev=`svn info | egrep "^Revision: .*$" | sed 's/^Revision: //'`

echo
echo "Release number: Major.Minor.Revision"
echo -en "New major release number [old = $old_major]: "; read new_major
if [ -z "$new_major"]; then new_major=$old_major; fi
echo -en "New minor release number [old = $old_minor]: "; read new_minor
if [ -z "$new_minor"]; then new_minor=$old_minor; fi
echo -en "New revision: $new_rev (current SVN revision)\n"

rnum=${new_major}.${new_minor}.${new_rev}
dbcpp_rnum=dbcpp_${new_major}_${new_minor}_${new_rev}

# Tar Ball #

echo
echo "Exporting SVN repository..." 
cd /tmp
svn export https://dbcpp.svn.sourceforge.net/svnroot/dbcpp $dbcpp_rnum
tar czf $dbcpp_rnum.tar.gz $dbcpp_rnum

echo
echo "Secure-copy tar-ball..."
echo -en "$server user: "; read user
scp $dbcpp_rnum.tar.gz $user@$server

# Manual Steps #

echo """# Lateset release number Major.Minor.Revision (Revision from SVN).
Major: $new_major
Minor: $new_minor
Revision: $new_rev" > $dbc_dir/bin/release.dat

echo -en """
IMPORTANT: To complete the release do the following manual steps.
1.  Log into 'http://sourceforge.net/projects/dbcpp/' as administrator.
2.  Select 'Project Admin > Feature Settings > File Release Systm > Manage'.
3.  For package name 'dbcpp', select 'Add Release' entering '$rnum' as
    'New Release Name'.
4.  Enter release notes from \"./RELEASE.txt\".
5.  Select \"$dbcpp_rnum.tar.gz\".
6.  Select 'Project Admin > Feature Settings > File Release System > Manage >
    Create / Edit Download Page' and enable the uploaded
    \"$dbcpp_rnum.tar.gz\" for download.
7.  Commit this sandbox to SVN (the release script made local modiciations).
"""

